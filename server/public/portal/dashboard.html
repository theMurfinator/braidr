<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Braidr - Customer Portal</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #fafafa;
      color: #1a1a1a;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      text-align: center;
      padding: 40px 20px;
      max-width: 520px;
      width: 100%;
    }
    .checkmark {
      width: 64px;
      height: 64px;
      background: #dcfce7;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
      font-size: 32px;
    }
    h1 { font-size: 24px; margin-bottom: 12px; }
    p { font-size: 15px; color: #71717a; line-height: 1.6; margin-bottom: 8px; }
    .steps {
      text-align: left;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 24px 28px;
      margin: 24px 0;
    }
    .steps h2 { font-size: 14px; color: #71717a; font-weight: 500; margin-bottom: 16px; }
    .steps ol {
      list-style: none;
      counter-reset: step;
    }
    .steps li {
      counter-increment: step;
      padding: 8px 0;
      font-size: 15px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    .steps li::before {
      content: counter(step);
      min-width: 24px;
      height: 24px;
      background: #f4f4f5;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      color: #71717a;
    }
    .btn {
      display: inline-block;
      padding: 12px 24px;
      background: #1a1a1a;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 500;
      text-decoration: none;
      cursor: pointer;
      transition: opacity 0.15s;
    }
    .btn:hover { opacity: 0.9; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary {
      background: #fff;
      color: #1a1a1a;
      border: 1px solid #e4e4e7;
    }
    .btn-secondary:hover { background: #f4f4f5; opacity: 1; }

    /* Lookup form */
    .lookup-form { margin: 24px 0; }
    .lookup-form input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #e4e4e7;
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
      outline: none;
      transition: border-color 0.15s;
      margin-bottom: 12px;
    }
    .lookup-form input:focus { border-color: #a1a1aa; }
    .lookup-form .divider {
      font-size: 13px;
      color: #a1a1aa;
      margin-bottom: 12px;
    }

    /* Account card */
    .account-card {
      text-align: left;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 28px;
      margin: 24px 0;
    }
    .account-card .label {
      font-size: 12px;
      font-weight: 600;
      color: #71717a;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }
    .account-card .value {
      font-size: 15px;
      color: #1a1a1a;
      margin-bottom: 20px;
      word-break: break-all;
    }
    .account-card .value:last-child { margin-bottom: 0; }
    .license-key-box {
      background: #f4f4f5;
      border-radius: 8px;
      padding: 14px 16px;
      font-family: 'SF Mono', 'Fira Code', 'Fira Mono', Menlo, monospace;
      font-size: 13px;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 20px;
    }
    .license-key-box code {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .copy-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 13px;
      color: #71717a;
      white-space: nowrap;
      transition: background 0.15s;
    }
    .copy-btn:hover { background: #e4e4e7; }

    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 500;
    }
    .status-active { background: #dcfce7; color: #166534; }
    .status-past-due { background: #fef9c3; color: #854d0e; }
    .status-canceled { background: #fee2e2; color: #991b1b; }
    .status-other { background: #f4f4f5; color: #71717a; }

    .button-row {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    .button-row .btn { flex: 1; text-align: center; }

    .error-msg {
      color: #dc2626;
      font-size: 14px;
      margin-top: 8px;
    }
    .muted { font-size: 13px; color: #a1a1aa; }

    .hidden { display: none; }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #e4e4e7;
      border-top-color: #1a1a1a;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-right: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">

    <!-- State: Checkout success -->
    <div id="state-success" class="hidden">
      <div class="checkmark">&#10003;</div>
      <h1>Welcome to Braidr!</h1>
      <p>Your license key is on its way to your email.</p>

      <div class="steps">
        <h2>Next steps</h2>
        <ol>
          <li>Check your email for your license key</li>
          <li>Open Braidr and go to Braidr &rarr; Manage License</li>
          <li>Paste your license key and click Activate</li>
        </ol>
      </div>

      <p class="muted">
        You can return to this portal anytime to view your license key or manage billing.
      </p>

      <div style="margin-top: 20px;">
        <button class="btn btn-secondary" onclick="showLookup()">Look Up My Account</button>
      </div>
    </div>

    <!-- State: Lookup form -->
    <div id="state-lookup" class="hidden">
      <h1>Customer Portal</h1>
      <p>Enter your license key or email to view your account.</p>

      <div class="lookup-form">
        <input type="text" id="input-key" placeholder="License key" autocomplete="off" spellcheck="false" />
        <div class="divider">or</div>
        <input type="email" id="input-email" placeholder="Email address" autocomplete="email" />
        <div id="lookup-error" class="error-msg hidden"></div>
        <div style="margin-top: 16px;">
          <button id="lookup-btn" class="btn" onclick="doLookup()">Look Up Account</button>
        </div>
      </div>

      <p class="muted" style="margin-top: 24px;">
        Your license key was emailed to you when you purchased Braidr.
      </p>
    </div>

    <!-- State: Loading -->
    <div id="state-loading" class="hidden">
      <div style="padding: 60px 0;">
        <span class="spinner"></span>
        <span style="font-size: 15px; color: #71717a;">Looking up your account...</span>
      </div>
    </div>

    <!-- State: Account details -->
    <div id="state-account" class="hidden">
      <h1>Your Account</h1>
      <p id="account-email" style="margin-bottom: 0;"></p>

      <div class="account-card">
        <div class="label">License Key</div>
        <div class="license-key-box">
          <code id="account-license-key"></code>
          <button class="copy-btn" onclick="copyKey()">Copy</button>
        </div>

        <div class="label">Plan</div>
        <div class="value" id="account-plan"></div>

        <div class="label">Status</div>
        <div class="value">
          <span class="status-badge" id="account-status"></span>
          <span id="account-cancel-note" class="hidden" style="display: none; margin-left: 8px; font-size: 13px; color: #854d0e;">
            &mdash; cancels at period end
          </span>
        </div>

        <div class="label">Current Period Ends</div>
        <div class="value" id="account-period-end" style="margin-bottom: 0;"></div>
      </div>

      <div class="button-row">
        <button class="btn" id="billing-btn" onclick="openBilling()">Manage Billing</button>
        <button class="btn btn-secondary" onclick="showLookup()">Log Out</button>
      </div>
    </div>

  </div>

  <script>
    var API_BASE = '';  // Same origin on Vercel
    var accountData = null;

    function show(stateId) {
      ['state-success', 'state-lookup', 'state-loading', 'state-account'].forEach(function(id) {
        document.getElementById(id).classList.add('hidden');
      });
      document.getElementById(stateId).classList.remove('hidden');
    }

    function showLookup() {
      document.getElementById('lookup-error').classList.add('hidden');
      document.getElementById('input-key').value = '';
      document.getElementById('input-email').value = '';
      show('state-lookup');
    }

    function showError(msg) {
      var el = document.getElementById('lookup-error');
      el.textContent = msg;
      el.classList.remove('hidden');
    }

    async function doLookup() {
      var key = document.getElementById('input-key').value.trim();
      var email = document.getElementById('input-email').value.trim();

      if (!key && !email) {
        showError('Please enter a license key or email address.');
        return;
      }

      document.getElementById('lookup-error').classList.add('hidden');
      show('state-loading');

      try {
        var body = {};
        if (key) body.licenseKey = key;
        else body.email = email;

        var resp = await fetch(API_BASE + '/api/portal/lookup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        if (!resp.ok) {
          var err = await resp.json().catch(function() { return {}; });
          show('state-lookup');
          showError(err.error || 'Account not found. Please check your license key or email.');
          return;
        }

        accountData = await resp.json();
        renderAccount(accountData);
      } catch (e) {
        show('state-lookup');
        showError('Could not connect to server. Please try again.');
      }
    }

    function renderAccount(data) {
      document.getElementById('account-email').textContent = data.email;
      document.getElementById('account-license-key').textContent = data.licenseKey || 'Not available';
      document.getElementById('account-plan').textContent = data.planName || 'Braidr';

      var statusEl = document.getElementById('account-status');
      var status = data.subscriptionStatus;
      statusEl.textContent = formatStatus(status);
      statusEl.className = 'status-badge ' + statusClass(status);

      var cancelNote = document.getElementById('account-cancel-note');
      if (data.cancelAtPeriodEnd) {
        cancelNote.style.display = 'inline';
      } else {
        cancelNote.style.display = 'none';
      }

      var periodEnd = document.getElementById('account-period-end');
      if (data.currentPeriodEnd) {
        periodEnd.textContent = new Date(data.currentPeriodEnd).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
        });
      } else {
        periodEnd.textContent = 'N/A';
      }

      show('state-account');
    }

    function formatStatus(status) {
      switch (status) {
        case 'active': return 'Active';
        case 'past_due': return 'Past Due';
        case 'canceled': return 'Canceled';
        case 'trialing': return 'Trialing';
        case 'unpaid': return 'Unpaid';
        default: return status ? status.charAt(0).toUpperCase() + status.slice(1) : 'Unknown';
      }
    }

    function statusClass(status) {
      switch (status) {
        case 'active':
        case 'trialing':
          return 'status-active';
        case 'past_due':
        case 'unpaid':
          return 'status-past-due';
        case 'canceled': return 'status-canceled';
        default: return 'status-other';
      }
    }

    function copyKey() {
      var key = document.getElementById('account-license-key').textContent;
      if (!key || key === 'Not available') return;
      navigator.clipboard.writeText(key).then(function() {
        var btn = document.querySelector('.copy-btn');
        btn.textContent = 'Copied!';
        setTimeout(function() { btn.textContent = 'Copy'; }, 2000);
      });
    }

    async function openBilling() {
      if (!accountData || !accountData.licenseKey) return;

      var btn = document.getElementById('billing-btn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>Opening...';

      try {
        var resp = await fetch(API_BASE + '/api/portal/billing', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ licenseKey: accountData.licenseKey }),
        });

        if (!resp.ok) {
          var err = await resp.json().catch(function() { return {}; });
          alert(err.error || 'Could not open billing portal. Please try again.');
          btn.disabled = false;
          btn.textContent = 'Manage Billing';
          return;
        }

        var result = await resp.json();
        window.location.href = result.url;
      } catch (e) {
        alert('Could not connect to server. Please try again.');
        btn.disabled = false;
        btn.textContent = 'Manage Billing';
      }
    }

    // Handle enter key in form inputs
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        var active = document.activeElement;
        if (active && (active.id === 'input-key' || active.id === 'input-email')) {
          doLookup();
        }
      }
    });

    // Initialize: decide which state to show
    (function init() {
      var params = new URLSearchParams(window.location.search);

      if (params.get('checkout') === 'success') {
        show('state-success');
        return;
      }

      var key = params.get('key');
      if (key) {
        document.getElementById('input-key').value = key;
        // Clean the URL so the key isn't sitting in the address bar
        window.history.replaceState({}, '', '/portal/dashboard');
        doLookup();
        return;
      }

      show('state-lookup');
    })();
  </script>
</body>
</html>
