# Migration Plan: Stripe + Keygen → LemonSqueezy

## Key URLs

| Service | URL |
|---|---|
| **Vercel API (production)** | `https://braidr-api.vercel.app` |
| **Webhook endpoint** | `https://braidr-api.vercel.app/api/webhooks/lemonsqueezy` |
| **Checkout endpoint** | `https://braidr-api.vercel.app/api/checkout` |
| **Billing portal endpoint** | `https://braidr-api.vercel.app/api/portal/billing` |

---

## Why migrate?

LemonSqueezy is an all-in-one platform that replaces **both** Stripe (payments) and Keygen (license management). This eliminates a service, reduces webhook complexity, and gives us a built-in customer portal — no more wiring two systems together.

| Capability | Current (2 services) | After (1 service) |
|---|---|---|
| Payments & subscriptions | Stripe | LemonSqueezy |
| License key generation | Keygen | LemonSqueezy |
| License key validation | Keygen API | LemonSqueezy License API |
| Customer billing portal | Stripe Customer Portal | LemonSqueezy Customer Portal |
| Webhook events | Stripe webhooks | LemonSqueezy webhooks |
| Email delivery | Resend (custom) | Resend (keep) or LS built-in |

---

## LemonSqueezy setup (dashboard)

Before writing code, configure in the [LemonSqueezy dashboard](https://app.lemonsqueezy.com):

1. **Create a Product** → "Braidr - Multi-POV Writing Tool"
2. **Create a Variant** → "$39/year" (recurring, annual billing)
   - Enable **license keys** on the variant
   - Set activation limit (e.g., 3 machines or unlimited)
   - License key length/format: default UUID is fine
3. **Copy IDs** — you'll need:
   - `LEMONSQUEEZY_API_KEY` — from Settings → API Keys
   - `LEMONSQUEEZY_STORE_ID` — from the URL or Settings
   - `LEMONSQUEEZY_PRODUCT_ID` — from Products
   - `LEMONSQUEEZY_VARIANT_ID` — from the variant you created
   - `LEMONSQUEEZY_WEBHOOK_SECRET` — from the webhook you create below
4. **Create a Webhook** → pointing at `https://braidr-api.vercel.app/api/webhooks/lemonsqueezy`
   - Events to subscribe to:
     - `order_created`
     - `subscription_created`
     - `subscription_updated`
     - `subscription_expired`
     - `subscription_payment_success`
     - `subscription_payment_failed`
     - `license_key_created`
   - Set a signing secret → this becomes `LEMONSQUEEZY_WEBHOOK_SECRET`

---

## Environment variables

### Old (remove)

```
STRIPE_SECRET_KEY=sk_live_...
STRIPE_WEBHOOK_SECRET=whsec_...
STRIPE_PRICE_ID=price_...
KEYGEN_ACCOUNT_ID=8abb6c6d-...
KEYGEN_POLICY_ID=49d61cba-...
KEYGEN_PRODUCT_TOKEN=prod-...
```

### New (add)

```
LEMONSQUEEZY_API_KEY=eyJ...
LEMONSQUEEZY_WEBHOOK_SECRET=your-webhook-signing-secret
LEMONSQUEEZY_STORE_ID=12345
LEMONSQUEEZY_VARIANT_ID=67890
```

### Unchanged

```
RESEND_API_KEY=re_...
FROM_EMAIL=Braidr <noreply@getbraider.com>
FEEDBACK_TO=feedback@getbraider.com
ADMIN_API_KEY=your-secret-admin-key
BASE_URL=https://braidr-api.vercel.app
```

---

## Files to change

### 1. `src/main/license.ts` (Electron app — license validation)

**What changes:**
- Replace Keygen validation API with LemonSqueezy License API
- Update `PURCHASE_URL` from `buy.stripe.com/...` to LemonSqueezy checkout URL
- Remove `KEYGEN_ACCOUNT_ID` and `KEYGEN_PRODUCT_ID` constants
- Add `LEMONSQUEEZY_STORE_ID` for response validation

**LemonSqueezy License API endpoints:**

```
POST https://api.lemonsqueezy.com/v1/licenses/validate
  Body (x-www-form-urlencoded): license_key=<key>
  → Returns: { valid, error, license_key: { status, key, expires_at }, meta: { store_id, product_id, customer_email } }

POST https://api.lemonsqueezy.com/v1/licenses/activate
  Body: license_key=<key>&instance_name=<machine-name>
  → Returns: { activated, error, license_key, instance, meta }

POST https://api.lemonsqueezy.com/v1/licenses/deactivate
  Body: license_key=<key>&instance_id=<id>
  → Returns: { deactivated, error, license_key, meta }
```

**Key difference from Keygen:** LS uses `application/x-www-form-urlencoded` (not JSON:API). No auth token needed for license validation — the license key itself is the credential.

**Security:** Verify `meta.store_id` matches your store ID in the response to prevent cross-store license abuse. Hard-code this check in the client.

**Implementation notes:**
- Replace `keygenRequest()` helper with `lemonsqueezyLicenseRequest()`
- The response shape changes: `license_key.status` can be `"active"`, `"inactive"`, `"expired"`, `"disabled"`
- `license_key.expires_at` replaces `data.attributes.expiry`
- `meta.customer_email` replaces `data.attributes.metadata.email`
- Consider using LS activation/deactivation to track machine instances (optional enhancement)

---

### 2. `server/api/webhooks/stripe.ts` → `server/api/webhooks/lemonsqueezy.ts`

**What changes:**
- Replace entire file — different signature verification and event structure
- Remove Stripe SDK and all Keygen API helper functions
- License keys are auto-generated by LS on purchase (no need to create them via API)
- The webhook's main job becomes: **email the license key** to the customer

**Signature verification:**
- LS sends `X-Signature` header (HMAC-SHA256 of raw body with webhook secret)
- Replace Stripe's `constructEvent()` with manual HMAC verification

**Events to handle:**

| LS Event | Action | Replaces |
|---|---|---|
| `order_created` | Email license key to customer | `checkout.session.completed` + Keygen license creation |
| `subscription_updated` | Check status; if cancelled/expired, log it | `customer.subscription.deleted` |
| `subscription_expired` | Log expiration (license auto-expires via LS) | N/A |
| `subscription_payment_failed` | Optionally notify customer | `invoice.payment_failed` |
| `license_key_created` | Alternative trigger for emailing the key | N/A (was manual Keygen creation) |

**Big simplification:** LS auto-generates license keys when an order is placed (if enabled on the variant). We no longer need to call an external API to create licenses. The webhook payload for `order_created` or `license_key_created` includes the license key directly.

---

### 3. `server/api/checkout.ts` — simplify or remove

**Options:**

**Option A (recommended): Direct checkout link** — remove the server endpoint entirely. Use a LemonSqueezy checkout URL directly from the landing page and Electron app:
```
https://[STORE].lemonsqueezy.com/checkout/buy/[VARIANT_ID]
```
Or with prefilled email and discount code:
```
https://[STORE].lemonsqueezy.com/checkout/buy/[VARIANT_ID]?checkout[email]=user@example.com&checkout[discount_code]=LAUNCH20
```

**Option B: API-created checkout** — keep the endpoint but replace Stripe with LS Checkouts API:
```
POST https://api.lemonsqueezy.com/v1/checkouts
Authorization: Bearer {LEMONSQUEEZY_API_KEY}
Body (JSON:API):
{
  "data": {
    "type": "checkouts",
    "relationships": {
      "store": { "data": { "type": "stores", "id": STORE_ID } },
      "variant": { "data": { "type": "variants", "id": VARIANT_ID } }
    },
    "attributes": {
      "checkout_data": { "email": "prefill@example.com" },
      "checkout_options": { "embed": true }
    }
  }
}
```
Response includes `data.attributes.url` — redirect the user there.

**Recommendation:** Start with Option A (simplest). Switch to Option B only if you need to dynamically prefill data or customize the checkout per-session.

---

### 4. `server/api/portal/billing.ts` — replace with LemonSqueezy customer portal

**What changes:**
- Remove Keygen license validation step (was used to get the customer email)
- Remove Stripe customer lookup and portal session creation
- Replace with: look up the LS subscription by customer email → return the signed `customer_portal` URL

**LemonSqueezy approach:**
1. Validate the license key via LS License API → get `meta.customer_id`
2. Fetch the customer object: `GET https://api.lemonsqueezy.com/v1/customers/{id}`
3. Return the signed `urls.customer_portal` URL from the response (valid 24 hours, auto-authenticates)

**Alternative (simpler):** Just link to `https://[STORE].lemonsqueezy.com/billing` — customers log in via email magic link. No server endpoint needed.

---

### 5. `server/api/_lib/email.ts` — minor updates

- Update the customer portal link in `licenseKeyEmail()` from `braidr-api.vercel.app/portal` to LemonSqueezy's portal URL
- Rest of the email template stays the same

**Alternative:** LemonSqueezy can send license key emails automatically. If you enable this in the dashboard, you can skip custom email sending entirely. However, keeping Resend gives you full control over branding.

---

### 6. `server/.env.example` — update variable names

Replace Stripe/Keygen vars with LemonSqueezy vars (see environment variables section above).

---

### 7. `server/package.json` — remove `stripe` dependency

```diff
- "stripe": "^17.0.0"
```

No LemonSqueezy SDK is needed — all API calls are simple `fetch()` requests.

---

### 8. `src/renderer/components/LicenseGate.tsx` — minor

- Purchase URL change is handled by `license.ts` (the component calls `api.openPurchaseUrl()`)
- No direct code changes needed unless we want to update button copy

---

### 9. `src/shared/types.ts` — no changes needed

The `LicenseStatus` and `LicenseData` interfaces remain the same. The states (`trial`, `licensed`, `expired`, `invalid`) map directly to LS license statuses.

---

## braidr-landing changes

### 1. `app/(marketing)/page.tsx`

Replace all Stripe URLs:

| Current | New |
|---|---|
| `https://buy.stripe.com/eVq00k3m761132Z13pa3u00` | `https://[STORE].lemonsqueezy.com/checkout/buy/[VARIANT_ID]` |
| `https://billing.stripe.com/p/login/eVq00k3m761132Z13pa3u00` | `https://[STORE].lemonsqueezy.com/billing` |

Optionally add `lemon.js` for checkout overlay:
```html
<script src="https://assets.lemonsqueezy.com/lemon.js" defer></script>
```
Then add `class="lemonsqueezy-button"` to purchase links for an overlay checkout experience.

### 2. `app/(marketing)/privacy/page.tsx`

Update payment processor reference from "Gumroad" (currently incorrect) to "LemonSqueezy".

---

## Migration order

### Phase 1: LemonSqueezy setup (no code changes)
- [ ] Create LS account, store, product, variant with license keys enabled
- [ ] Set up webhook endpoint in LS dashboard
- [ ] Get all API keys and IDs
- [ ] Test checkout flow manually in LS test mode

### Phase 2: Server-side (braidr)
- [ ] Create `server/api/webhooks/lemonsqueezy.ts` with HMAC verification
- [ ] Update `server/api/_lib/email.ts` portal link
- [ ] Update `server/api/portal/billing.ts` to use LS customer portal
- [ ] Simplify or remove `server/api/checkout.ts`
- [ ] Update `server/.env.example`
- [ ] Remove `stripe` from `server/package.json`
- [ ] Delete `server/api/webhooks/stripe.ts`
- [ ] Deploy to Vercel with new env vars

### Phase 3: Electron app (braidr)
- [ ] Rewrite license validation in `src/main/license.ts` to use LS License API
- [ ] Update `PURCHASE_URL` to LS checkout link
- [ ] Test: activate, validate, deactivate, expired, offline grace
- [ ] Build and sign new app version

### Phase 4: Landing page (braidr-landing)
- [ ] Replace Stripe URLs in `page.tsx` with LS checkout/billing URLs
- [ ] Optionally add `lemon.js` for overlay checkout
- [ ] Fix privacy policy payment processor reference
- [ ] Deploy

### Phase 5: Cleanup
- [ ] Remove old `Launch/stripe-keygen-setup.md` or archive it
- [ ] Remove `Launch/stripe-keygen-webhook.ts` and `Launch/stripe-checkout.ts` templates
- [ ] Cancel Keygen account / deactivate API tokens
- [ ] Archive Stripe webhook endpoint
- [ ] Update `LAUNCH_CHECKLIST.md` with new env var names
- [ ] Verify existing customers (if any) are migrated or re-issued LS keys

---

## Existing customer migration

If there are existing paying customers on Stripe + Keygen:

1. Export customer emails and subscription status from Stripe
2. Create corresponding LS subscriptions (or handle manually if small number)
3. Generate LS license keys for each customer
4. Email new license keys with instructions to update in-app
5. Keep old Keygen validation live for a grace period (e.g., 30 days) so old keys still work while customers transition

If there are no existing customers yet (pre-launch), skip this entirely.

---

## Key LemonSqueezy API reference

| Endpoint | Method | Auth | Purpose |
|---|---|---|---|
| `/v1/licenses/validate` | POST | None (key is auth) | Validate a license key |
| `/v1/licenses/activate` | POST | None | Activate key on a machine |
| `/v1/licenses/deactivate` | POST | None | Deactivate key on a machine |
| `/v1/checkouts` | POST | Bearer token | Create custom checkout URL |
| `/v1/customers/{id}` | GET | Bearer token | Get customer (includes portal URL) |
| `/v1/subscriptions/{id}` | GET | Bearer token | Get subscription (includes portal URL) |

Content-Type for License API: `application/x-www-form-urlencoded`
Content-Type for main API: `application/vnd.api+json`
Webhook signature: HMAC-SHA256 in `X-Signature` header
